#!/usr/bin/env python3
"""
Pentest Suite - Ferramenta Automatizada de Teste de Penetração
Baseado em OWASP Top 10

Autor: Pentest Suite Team
Versão: 1.0.0

AVISO LEGAL:
Esta ferramenta deve ser usada APENAS para fins educacionais e em sistemas
onde você tem AUTORIZAÇÃO EXPLÍCITA para realizar testes de segurança.
O uso não autorizado é ILEGAL e pode resultar em consequências legais.
"""

import argparse
import sys
import warnings
from pentest_suite.modules.recon import ReconModule
from pentest_suite.modules.endpoint_discovery import EndpointDiscovery
from pentest_suite.modules.vuln_scanner import VulnerabilityScanner
from pentest_suite.modules.reporter import Reporter

# Desabilita warnings SSL para testes
warnings.filterwarnings('ignore', message='Unverified HTTPS request')


def print_banner():
    """Imprime banner da ferramenta"""
    banner = """
╔═══════════════════════════════════════════════════════════════════╗
║                                                                   ║
║   ██████╗ ███████╗███╗   ██╗████████╗███████╗███████╗████████╗   ║
║   ██╔══██╗██╔════╝████╗  ██║╚══██╔══╝██╔════╝██╔════╝╚══██╔══╝   ║
║   ██████╔╝█████╗  ██╔██╗ ██║   ██║   █████╗  ███████╗   ██║      ║
║   ██╔═══╝ ██╔══╝  ██║╚██╗██║   ██║   ██╔══╝  ╚════██║   ██║      ║
║   ██║     ███████╗██║ ╚████║   ██║   ███████╗███████║   ██║      ║
║   ╚═╝     ╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚══════╝╚══════╝   ╚═╝      ║
║                                                                   ║
║              Automated Penetration Testing Suite                 ║
║                    OWASP Top 10 Based - v1.0.0                   ║
║                                                                   ║
╚═══════════════════════════════════════════════════════════════════╝

[!] AVISO LEGAL: Use apenas em sistemas autorizados!
"""
    print(banner)


def run_full_scan(target, args):
    """
    Executa scan completo: reconhecimento, descoberta e vulnerabilidades
    """
    print(f"\n[*] Iniciando scan completo em: {target}")
    print("=" * 80)

    recon_data = None
    endpoint_data = None
    vuln_data = None

    # FASE 1: RECONHECIMENTO
    if not args.skip_recon:
        print("\n[FASE 1] RECONHECIMENTO")
        print("-" * 80)

        recon = ReconModule(target, timeout=args.timeout)

        if args.subdomain_enum:
            recon.subdomain_enumeration()

        if args.port_scan:
            recon.port_scan()

        if args.tech_detect:
            # Garante que a URL tenha protocolo
            url = target if target.startswith('http') else f"http://{target}"
            recon.detect_technologies(url)

        recon_data = recon.get_full_report()

    # FASE 2: DESCOBERTA DE ENDPOINTS
    if not args.skip_discovery:
        print("\n[FASE 2] DESCOBERTA DE ENDPOINTS")
        print("-" * 80)

        # Garante que a URL tenha protocolo
        url = target if target.startswith('http') else f"http://{target}"

        discovery = EndpointDiscovery(url, timeout=args.timeout,
                                     max_depth=args.crawl_depth)

        if args.crawl:
            discovery.crawl()

        if args.bruteforce:
            discovery.directory_bruteforce()

        discovery.check_common_files()
        discovery.detect_api_endpoints()

        endpoint_data = discovery.get_full_report()

    # FASE 3: SCAN DE VULNERABILIDADES
    if not args.skip_vulnscan:
        print("\n[FASE 3] SCAN DE VULNERABILIDADES")
        print("-" * 80)

        # Garante que a URL tenha protocolo
        url = target if target.startswith('http') else f"http://{target}"

        scanner = VulnerabilityScanner(url, timeout=args.timeout)

        endpoints = endpoint_data['discovered_endpoints'] if endpoint_data else [url]
        forms = endpoint_data['forms'] if endpoint_data else []

        scanner.scan_all(endpoints, forms)

        vuln_data = scanner.get_report()

    # FASE 4: GERAÇÃO DE RELATÓRIOS
    print("\n[FASE 4] GERAÇÃO DE RELATÓRIOS")
    print("-" * 80)

    reporter = Reporter(output_dir=args.output)
    report_formats = args.format.split(',')

    report_paths = reporter.generate_report(
        target=target,
        recon_data=recon_data,
        endpoint_data=endpoint_data,
        vuln_data=vuln_data,
        formats=report_formats
    )

    # RESUMO FINAL
    print("\n" + "=" * 80)
    print("SCAN COMPLETO!")
    print("=" * 80)

    if recon_data:
        print(f"\n[Reconhecimento]")
        print(f"  - Subdomínios: {len(recon_data.get('subdomains', []))}")
        print(f"  - Portas abertas: {len(recon_data.get('open_ports', []))}")

    if endpoint_data:
        print(f"\n[Descoberta]")
        print(f"  - Endpoints: {endpoint_data.get('total_endpoints', 0)}")
        print(f"  - Formulários: {len(endpoint_data.get('forms', []))}")

    if vuln_data:
        print(f"\n[Vulnerabilidades]")
        print(f"  - Total: {vuln_data['total_vulnerabilities']}")
        for severity, count in vuln_data['by_severity'].items():
            if count > 0:
                print(f"  - {severity}: {count}")

    print(f"\n[Relatórios]")
    for report_path in report_paths:
        print(f"  - {report_path}")

    print("\n" + "=" * 80)


def run_recon_only(target, args):
    """Executa apenas reconhecimento"""
    print(f"\n[*] Executando reconhecimento em: {target}")
    print("=" * 80)

    recon = ReconModule(target, timeout=args.timeout)

    if args.subdomain_enum:
        recon.subdomain_enumeration()

    if args.port_scan:
        recon.port_scan()

    if args.tech_detect:
        url = target if target.startswith('http') else f"http://{target}"
        recon.detect_technologies(url)

    recon_data = recon.get_full_report()

    # Gera relatório
    reporter = Reporter(output_dir=args.output)
    report_paths = reporter.generate_report(
        target=target,
        recon_data=recon_data,
        formats=args.format.split(',')
    )

    print(f"\n[+] Relatórios gerados:")
    for path in report_paths:
        print(f"  - {path}")


def run_discovery_only(target, args):
    """Executa apenas descoberta de endpoints"""
    print(f"\n[*] Executando descoberta de endpoints em: {target}")
    print("=" * 80)

    url = target if target.startswith('http') else f"http://{target}"
    discovery = EndpointDiscovery(url, timeout=args.timeout,
                                 max_depth=args.crawl_depth)

    if args.crawl:
        discovery.crawl()

    if args.bruteforce:
        discovery.directory_bruteforce()

    discovery.check_common_files()
    discovery.detect_api_endpoints()

    endpoint_data = discovery.get_full_report()

    # Gera relatório
    reporter = Reporter(output_dir=args.output)
    report_paths = reporter.generate_report(
        target=target,
        endpoint_data=endpoint_data,
        formats=args.format.split(',')
    )

    print(f"\n[+] Relatórios gerados:")
    for path in report_paths:
        print(f"  - {path}")


def run_vulnscan_only(target, args):
    """Executa apenas scan de vulnerabilidades"""
    print(f"\n[*] Executando scan de vulnerabilidades em: {target}")
    print("=" * 80)

    url = target if target.startswith('http') else f"http://{target}"
    scanner = VulnerabilityScanner(url, timeout=args.timeout)

    scanner.scan_all([url])

    vuln_data = scanner.get_report()

    # Gera relatório
    reporter = Reporter(output_dir=args.output)
    report_paths = reporter.generate_report(
        target=target,
        vuln_data=vuln_data,
        formats=args.format.split(',')
    )

    print(f"\n[+] Relatórios gerados:")
    for path in report_paths:
        print(f"  - {path}")


def main():
    parser = argparse.ArgumentParser(
        description='Pentest Suite - Automated Penetration Testing Tool',
        epilog='Use apenas em sistemas autorizados!',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    # Argumentos principais
    parser.add_argument('target', help='Target URL, IP ou domínio')

    parser.add_argument('-m', '--mode', choices=['full', 'recon', 'discovery', 'vulnscan'],
                       default='full', help='Modo de execução (default: full)')

    # Opções de reconhecimento
    recon_group = parser.add_argument_group('Reconhecimento')
    recon_group.add_argument('--subdomain-enum', action='store_true',
                            help='Habilita enumeração de subdomínios')
    recon_group.add_argument('--port-scan', action='store_true',
                            help='Habilita scan de portas')
    recon_group.add_argument('--tech-detect', action='store_true',
                            help='Habilita detecção de tecnologias')

    # Opções de descoberta
    discovery_group = parser.add_argument_group('Descoberta de Endpoints')
    discovery_group.add_argument('--crawl', action='store_true',
                                help='Habilita web crawling')
    discovery_group.add_argument('--bruteforce', action='store_true',
                                help='Habilita directory bruteforce')
    discovery_group.add_argument('--crawl-depth', type=int, default=3,
                                help='Profundidade máxima do crawl (default: 3)')

    # Opções de skip
    skip_group = parser.add_argument_group('Skip Options')
    skip_group.add_argument('--skip-recon', action='store_true',
                           help='Pula fase de reconhecimento')
    skip_group.add_argument('--skip-discovery', action='store_true',
                           help='Pula fase de descoberta')
    skip_group.add_argument('--skip-vulnscan', action='store_true',
                           help='Pula fase de scan de vulnerabilidades')

    # Opções gerais
    parser.add_argument('-t', '--timeout', type=int, default=5,
                       help='Timeout para requisições em segundos (default: 5)')
    parser.add_argument('-o', '--output', default='reports',
                       help='Diretório para salvar relatórios (default: reports)')
    parser.add_argument('-f', '--format', default='json,html,txt',
                       help='Formatos de relatório separados por vírgula (default: json,html,txt)')
    parser.add_argument('--verbose', action='store_true',
                       help='Modo verbose')

    args = parser.parse_args()

    # Banner
    print_banner()

    # Validação do target
    if not args.target:
        print("[!] Erro: Target é obrigatório")
        parser.print_help()
        sys.exit(1)

    # Confirmação
    print(f"\n[!] Target: {args.target}")
    print(f"[!] Modo: {args.mode}")
    print(f"\n[?] Você tem autorização para realizar testes neste sistema? (yes/no): ", end='')

    confirmation = input().strip().lower()
    if confirmation not in ['yes', 'y', 'sim', 's']:
        print("\n[!] Operação cancelada.")
        sys.exit(0)

    # Executa modo selecionado
    try:
        if args.mode == 'full':
            run_full_scan(args.target, args)
        elif args.mode == 'recon':
            run_recon_only(args.target, args)
        elif args.mode == 'discovery':
            run_discovery_only(args.target, args)
        elif args.mode == 'vulnscan':
            run_vulnscan_only(args.target, args)

    except KeyboardInterrupt:
        print("\n\n[!] Scan interrompido pelo usuário")
        sys.exit(0)
    except Exception as e:
        print(f"\n[!] Erro durante execução: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
