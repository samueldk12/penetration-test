"""
Módulo de Relatórios
Gera relatórios em diferentes formatos (JSON, HTML, TXT)
"""

import json
from datetime import datetime
from typing import Dict, List
import os


class Reporter:
    def __init__(self, output_dir: str = 'reports'):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)

    def generate_report(self, target: str, recon_data: Dict = None,
                       endpoint_data: Dict = None, vuln_data: Dict = None,
                       formats: List[str] = None):
        """
        Gera relatório em múltiplos formatos
        """
        if formats is None:
            formats = ['json', 'html', 'txt']

        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        base_filename = f"pentest_report_{target.replace('://', '_').replace('/', '_')}_{timestamp}"

        report_data = {
            'target': target,
            'scan_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'reconnaissance': recon_data or {},
            'endpoint_discovery': endpoint_data or {},
            'vulnerabilities': vuln_data or {}
        }

        report_paths = []

        if 'json' in formats:
            json_path = self._generate_json_report(base_filename, report_data)
            report_paths.append(json_path)

        if 'html' in formats:
            html_path = self._generate_html_report(base_filename, report_data)
            report_paths.append(html_path)

        if 'txt' in formats:
            txt_path = self._generate_txt_report(base_filename, report_data)
            report_paths.append(txt_path)

        return report_paths

    def _generate_json_report(self, base_filename: str, data: Dict) -> str:
        """Gera relatório em formato JSON"""
        filepath = os.path.join(self.output_dir, f"{base_filename}.json")

        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=2, ensure_ascii=False)

        print(f"[+] Relatório JSON gerado: {filepath}")
        return filepath

    def _generate_txt_report(self, base_filename: str, data: Dict) -> str:
        """Gera relatório em formato TXT"""
        filepath = os.path.join(self.output_dir, f"{base_filename}.txt")

        with open(filepath, 'w', encoding='utf-8') as f:
            f.write("=" * 80 + "\n")
            f.write("RELATÓRIO DE TESTE DE PENETRAÇÃO\n")
            f.write("=" * 80 + "\n\n")

            f.write(f"Target: {data['target']}\n")
            f.write(f"Data do Scan: {data['scan_date']}\n\n")

            # Reconhecimento
            if data.get('reconnaissance'):
                recon = data['reconnaissance']
                f.write("-" * 80 + "\n")
                f.write("RECONHECIMENTO\n")
                f.write("-" * 80 + "\n\n")

                if recon.get('subdomains'):
                    f.write(f"Subdomínios Encontrados ({len(recon['subdomains'])}):\n")
                    for subdomain in recon['subdomains']:
                        f.write(f"  - {subdomain}\n")
                    f.write("\n")

                if recon.get('open_ports'):
                    f.write(f"Portas Abertas ({len(recon['open_ports'])}):\n")
                    for port_info in recon['open_ports']:
                        f.write(f"  - {port_info['port']}/tcp - {port_info['service']}")
                        if port_info.get('banner'):
                            f.write(f" ({port_info['banner'][:50]}...)")
                        f.write("\n")
                    f.write("\n")

                if recon.get('technologies'):
                    tech = recon['technologies']
                    f.write("Tecnologias Detectadas:\n")
                    if tech.get('server'):
                        f.write(f"  Server: {tech['server']}\n")
                    if tech.get('cms'):
                        f.write(f"  CMS: {tech['cms']}\n")
                    if tech.get('frameworks'):
                        f.write(f"  Frameworks: {', '.join(tech['frameworks'])}\n")
                    if tech.get('javascript_libs'):
                        f.write(f"  JS Libraries: {', '.join(tech['javascript_libs'])}\n")
                    f.write("\n")

            # Descoberta de Endpoints
            if data.get('endpoint_discovery'):
                endpoints = data['endpoint_discovery']
                f.write("-" * 80 + "\n")
                f.write("DESCOBERTA DE ENDPOINTS\n")
                f.write("-" * 80 + "\n\n")

                if endpoints.get('discovered_endpoints'):
                    f.write(f"Total de Endpoints: {endpoints['total_endpoints']}\n\n")
                    f.write("Endpoints Encontrados:\n")
                    for endpoint in endpoints['discovered_endpoints'][:50]:  # Limita a 50
                        f.write(f"  - {endpoint}\n")
                    if endpoints['total_endpoints'] > 50:
                        f.write(f"  ... e mais {endpoints['total_endpoints'] - 50} endpoints\n")
                    f.write("\n")

                if endpoints.get('forms'):
                    f.write(f"Formulários Encontrados ({len(endpoints['forms'])}):\n")
                    for form in endpoints['forms']:
                        f.write(f"  - {form['action']} ({form['method'].upper()})\n")
                        for input_field in form['inputs'][:5]:  # Limita a 5 inputs por form
                            f.write(f"    * {input_field['name']} ({input_field['type']})\n")
                    f.write("\n")

            # Vulnerabilidades
            if data.get('vulnerabilities'):
                vulns = data['vulnerabilities']
                f.write("-" * 80 + "\n")
                f.write("VULNERABILIDADES ENCONTRADAS\n")
                f.write("-" * 80 + "\n\n")

                f.write(f"Total de Vulnerabilidades: {vulns['total_vulnerabilities']}\n\n")

                f.write("Por Severidade:\n")
                for severity, count in vulns['by_severity'].items():
                    if count > 0:
                        f.write(f"  - {severity}: {count}\n")
                f.write("\n")

                # Agrupa por severidade
                for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']:
                    severity_vulns = [v for v in vulns['vulnerabilities']
                                    if v['severity'] == severity]

                    if severity_vulns:
                        f.write(f"\n{severity} Severity:\n")
                        f.write("=" * 80 + "\n\n")

                        for vuln in severity_vulns:
                            f.write(f"[{vuln['severity']}] {vuln['type']}\n")
                            f.write(f"URL: {vuln['url']}\n")
                            f.write(f"Descrição: {vuln['description']}\n")
                            if vuln.get('details'):
                                f.write(f"Detalhes: {json.dumps(vuln['details'], indent=2)}\n")
                            f.write(f"Timestamp: {vuln['timestamp']}\n")
                            f.write("-" * 80 + "\n\n")

            f.write("=" * 80 + "\n")
            f.write("FIM DO RELATÓRIO\n")
            f.write("=" * 80 + "\n")

        print(f"[+] Relatório TXT gerado: {filepath}")
        return filepath

    def _generate_html_report(self, base_filename: str, data: Dict) -> str:
        """Gera relatório em formato HTML"""
        filepath = os.path.join(self.output_dir, f"{base_filename}.html")

        html_content = f"""<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Teste de Penetração - {data['target']}</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }}

        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }}

        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }}

        .header h1 {{
            font-size: 2.5em;
            margin-bottom: 10px;
        }}

        .header .meta {{
            font-size: 1.1em;
            opacity: 0.9;
        }}

        .content {{
            padding: 30px;
        }}

        .section {{
            margin-bottom: 40px;
        }}

        .section-title {{
            font-size: 1.8em;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }}

        .summary {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }}

        .summary-card {{
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }}

        .summary-card .number {{
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }}

        .summary-card .label {{
            color: #666;
            font-size: 0.9em;
        }}

        .vulnerability {{
            background: white;
            border: 1px solid #ddd;
            border-left: 4px solid;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }}

        .vulnerability:hover {{
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }}

        .vulnerability.CRITICAL {{
            border-left-color: #dc3545;
            background: #fff5f5;
        }}

        .vulnerability.HIGH {{
            border-left-color: #fd7e14;
            background: #fff8f5;
        }}

        .vulnerability.MEDIUM {{
            border-left-color: #ffc107;
            background: #fffbf5;
        }}

        .vulnerability.LOW {{
            border-left-color: #28a745;
            background: #f5fff8;
        }}

        .vulnerability.INFO {{
            border-left-color: #17a2b8;
            background: #f5fcff;
        }}

        .severity-badge {{
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin-right: 10px;
        }}

        .severity-badge.CRITICAL {{ background: #dc3545; }}
        .severity-badge.HIGH {{ background: #fd7e14; }}
        .severity-badge.MEDIUM {{ background: #ffc107; color: #333; }}
        .severity-badge.LOW {{ background: #28a745; }}
        .severity-badge.INFO {{ background: #17a2b8; }}

        .vuln-title {{
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
        }}

        .vuln-url {{
            color: #667eea;
            word-break: break-all;
            margin-bottom: 10px;
        }}

        .vuln-description {{
            color: #666;
            margin-bottom: 10px;
        }}

        .vuln-details {{
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }}

        .list-item {{
            padding: 10px;
            border-bottom: 1px solid #eee;
        }}

        .list-item:last-child {{
            border-bottom: none;
        }}

        .badge {{
            display: inline-block;
            padding: 3px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }}

        table {{
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }}

        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}

        th {{
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }}

        tr:hover {{
            background: #f8f9fa;
        }}

        .footer {{
            background: #333;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Relatório de Teste de Penetração</h1>
            <div class="meta">
                <strong>Target:</strong> {data['target']}<br>
                <strong>Data do Scan:</strong> {data['scan_date']}
            </div>
        </div>

        <div class="content">
"""

        # Summary
        if data.get('vulnerabilities'):
            vulns = data['vulnerabilities']
            html_content += """
            <div class="section">
                <h2 class="section-title">Resumo Executivo</h2>
                <div class="summary">
"""
            html_content += f"""
                    <div class="summary-card">
                        <div class="number">{vulns['total_vulnerabilities']}</div>
                        <div class="label">Total de Vulnerabilidades</div>
                    </div>
"""
            for severity, count in vulns['by_severity'].items():
                if count > 0:
                    html_content += f"""
                    <div class="summary-card">
                        <div class="number">{count}</div>
                        <div class="label">{severity}</div>
                    </div>
"""
            html_content += """
                </div>
            </div>
"""

        # Reconhecimento
        if data.get('reconnaissance'):
            recon = data['reconnaissance']
            html_content += """
            <div class="section">
                <h2 class="section-title">Reconhecimento</h2>
"""
            if recon.get('subdomains'):
                html_content += f"""
                <h3>Subdomínios <span class="badge">{len(recon['subdomains'])}</span></h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
"""
                for subdomain in recon['subdomains'][:20]:
                    html_content += f"                    <div class='list-item'>{subdomain}</div>\n"
                if len(recon['subdomains']) > 20:
                    html_content += f"                    <div class='list-item'><em>... e mais {len(recon['subdomains']) - 20} subdomínios</em></div>\n"
                html_content += """
                </div>
"""

            if recon.get('open_ports'):
                html_content += f"""
                <h3>Portas Abertas <span class="badge">{len(recon['open_ports'])}</span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Porta</th>
                            <th>Serviço</th>
                            <th>Banner</th>
                        </tr>
                    </thead>
                    <tbody>
"""
                for port_info in recon['open_ports']:
                    banner = port_info.get('banner', '')[:100] if port_info.get('banner') else 'N/A'
                    html_content += f"""
                        <tr>
                            <td>{port_info['port']}/tcp</td>
                            <td>{port_info['service']}</td>
                            <td>{banner}</td>
                        </tr>
"""
                html_content += """
                    </tbody>
                </table>
"""

            if recon.get('technologies'):
                tech = recon['technologies']
                html_content += """
                <h3>Tecnologias Detectadas</h3>
                <table>
                    <tbody>
"""
                if tech.get('server'):
                    html_content += f"<tr><td><strong>Server</strong></td><td>{tech['server']}</td></tr>"
                if tech.get('cms'):
                    html_content += f"<tr><td><strong>CMS</strong></td><td>{tech['cms']}</td></tr>"
                if tech.get('frameworks'):
                    html_content += f"<tr><td><strong>Frameworks</strong></td><td>{', '.join(tech['frameworks'])}</td></tr>"
                if tech.get('javascript_libs'):
                    html_content += f"<tr><td><strong>JS Libraries</strong></td><td>{', '.join(tech['javascript_libs'])}</td></tr>"
                html_content += """
                    </tbody>
                </table>
"""
            html_content += """
            </div>
"""

        # Endpoints
        if data.get('endpoint_discovery'):
            endpoints = data['endpoint_discovery']
            html_content += f"""
            <div class="section">
                <h2 class="section-title">Descoberta de Endpoints</h2>
                <p>Total de endpoints encontrados: <strong>{endpoints.get('total_endpoints', 0)}</strong></p>
"""
            if endpoints.get('forms'):
                html_content += f"""
                <h3>Formulários <span class="badge">{len(endpoints['forms'])}</span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Método</th>
                            <th>Campos</th>
                        </tr>
                    </thead>
                    <tbody>
"""
                for form in endpoints['forms'][:20]:
                    fields = ', '.join([inp['name'] for inp in form['inputs'] if inp['name']][:5])
                    html_content += f"""
                        <tr>
                            <td>{form['action']}</td>
                            <td>{form['method'].upper()}</td>
                            <td>{fields}</td>
                        </tr>
"""
                html_content += """
                    </tbody>
                </table>
"""
            html_content += """
            </div>
"""

        # Vulnerabilidades
        if data.get('vulnerabilities'):
            vulns = data['vulnerabilities']
            html_content += """
            <div class="section">
                <h2 class="section-title">Vulnerabilidades Encontradas</h2>
"""
            for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']:
                severity_vulns = [v for v in vulns['vulnerabilities']
                                if v['severity'] == severity]

                if severity_vulns:
                    html_content += f"""
                <h3>{severity} <span class="badge">{len(severity_vulns)}</span></h3>
"""
                    for vuln in severity_vulns:
                        details_json = json.dumps(vuln.get('details', {}), indent=2)
                        html_content += f"""
                <div class="vulnerability {vuln['severity']}">
                    <div class="vuln-title">
                        <span class="severity-badge {vuln['severity']}">{vuln['severity']}</span>
                        {vuln['type']}
                    </div>
                    <div class="vuln-url"><strong>URL:</strong> {vuln['url']}</div>
                    <div class="vuln-description">{vuln['description']}</div>
"""
                        if vuln.get('details'):
                            html_content += f"""
                    <div class="vuln-details">
                        <strong>Detalhes:</strong><br>
                        <pre>{details_json}</pre>
                    </div>
"""
                        html_content += f"""
                    <div style="margin-top: 10px; font-size: 0.85em; color: #999;">
                        <strong>Timestamp:</strong> {vuln['timestamp']}
                    </div>
                </div>
"""

            html_content += """
            </div>
"""

        html_content += """
        </div>

        <div class="footer">
            <p>Relatório gerado automaticamente pela Pentest Suite</p>
            <p>Este relatório é confidencial e deve ser usado apenas para fins autorizados</p>
        </div>
    </div>
</body>
</html>
"""

        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(html_content)

        print(f"[+] Relatório HTML gerado: {filepath}")
        return filepath
