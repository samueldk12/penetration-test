#!/usr/bin/env python3
"""
Advanced Penetration Testing Scanner
Automated vulnerability testing tool for authorized security assessments
"""

import argparse
import sys
from modules.recon import ReconModule
from modules.vulnerability_scanner import VulnerabilityScanner
from modules.logger import BugBountyLogger
from modules.report_generator import ReportGenerator

def banner():
    print("""
╔═══════════════════════════════════════════════════════════╗
║     Advanced Penetration Testing Scanner v2.0            ║
║     Automated Security Testing for Bug Bounty Programs   ║
╚═══════════════════════════════════════════════════════════╝
    """)

def main():
    banner()

    parser = argparse.ArgumentParser(description='Advanced Penetration Testing Scanner')
    parser.add_argument('-t', '--target', required=True, help='Target URL or domain')
    parser.add_argument('-m', '--mode', choices=['recon', 'scan', 'full'], default='full',
                        help='Scan mode: recon (reconnaissance only), scan (vulnerability scan), full (both)')
    parser.add_argument('-o', '--output', default='pentest_report', help='Output report filename')
    parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    parser.add_argument('--threads', type=int, default=10, help='Number of threads (default: 10)')
    parser.add_argument('--timeout', type=int, default=10, help='Request timeout in seconds (default: 10)')
    parser.add_argument('--proxy', help='Proxy URL (e.g., http://127.0.0.1:8080)')
    parser.add_argument('--skip-ssl', action='store_true', help='Skip SSL verification')

    args = parser.parse_args()

    # Initialize logger
    logger = BugBountyLogger(args.output, verbose=args.verbose)
    logger.log_info(f"Starting scan on target: {args.target}")

    try:
        # Reconnaissance phase
        if args.mode in ['recon', 'full']:
            logger.log_info("Starting reconnaissance phase...")
            recon = ReconModule(args.target, logger, threads=args.threads, timeout=args.timeout, proxy=args.proxy)
            recon_results = recon.run_full_recon()
            logger.log_recon_results(recon_results)

        # Vulnerability scanning phase
        if args.mode in ['scan', 'full']:
            logger.log_info("Starting vulnerability scanning phase...")
            scanner = VulnerabilityScanner(
                args.target,
                logger,
                threads=args.threads,
                timeout=args.timeout,
                proxy=args.proxy,
                verify_ssl=not args.skip_ssl
            )
            vuln_results = scanner.run_all_scans()
            logger.log_vulnerability_results(vuln_results)

        # Generate report
        logger.log_info("Generating final report...")
        report_gen = ReportGenerator(logger)
        report_gen.generate_report(args.output)

        print(f"\n[+] Scan completed! Report saved to: {args.output}.html")

    except KeyboardInterrupt:
        logger.log_error("Scan interrupted by user")
        sys.exit(1)
    except Exception as e:
        logger.log_error(f"Fatal error: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
