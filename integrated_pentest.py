#!/usr/bin/env python3
"""
Integrated Penetration Testing Suite
Combines Interactive Selenium, Proxy, and Console Testing
"""

import sys
import json
import threading
import time
import argparse


def start_proxy(port=8888):
    """Start proxy in background thread"""
    print(f"[*] Starting proxy on port {port}...")

    try:
        from proxy.pentest_proxy import PentestProxy

        proxy = PentestProxy(port, {'verbose': False})

        thread = threading.Thread(target=proxy.start, daemon=True)
        thread.start()

        time.sleep(2)  # Give proxy time to start
        return proxy

    except ImportError:
        print("[!] Proxy module not available")
        return None
    except Exception as e:
        print(f"[!] Failed to start proxy: {e}")
        return None


def run_console_tests(target, options=None):
    """Run console tests"""
    print(f"\n[*] Running console tests...")

    try:
        from console_testing.console_tester import ConsoleTester

        tester = ConsoleTester(target, options or {})
        return tester.run()

    except ImportError:
        print("[!] Console testing module not available")
        return None
    except Exception as e:
        print(f"[!] Console tests failed: {e}")
        return None


def run_interactive_mode(target, options=None):
    """Run interactive Selenium mode"""
    print(f"\n[*] Starting interactive mode...")

    try:
        from plugins.interactive_testing.selenium_interactive.selenium_interactive import InteractivePentester

        tester = InteractivePentester(target, options or {})
        return tester.run()

    except ImportError:
        print("[!] Interactive mode not available")
        return None
    except Exception as e:
        print(f"[!] Interactive mode failed: {e}")
        return None


def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description='Integrated Penetration Testing Suite',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # Interactive mode with proxy
  python3 integrated_pentest.py https://example.com --mode interactive --proxy

  # Console tests only
  python3 integrated_pentest.py https://example.com --mode console

  # Full suite with all modules
  python3 integrated_pentest.py https://example.com --mode full --proxy

  # Interactive mode with custom proxy port
  python3 integrated_pentest.py https://example.com --mode interactive --proxy --proxy-port 9999
'''
    )

    parser.add_argument('target', help='Target URL')

    parser.add_argument(
        '--mode',
        choices=['interactive', 'console', 'full'],
        default='interactive',
        help='Testing mode (default: interactive)'
    )

    parser.add_argument(
        '--proxy',
        action='store_true',
        help='Enable proxy server'
    )

    parser.add_argument(
        '--proxy-port',
        type=int,
        default=8888,
        help='Proxy port (default: 8888)'
    )

    parser.add_argument(
        '--browser',
        choices=['chrome', 'firefox'],
        default='chrome',
        help='Browser to use (default: chrome)'
    )

    parser.add_argument(
        '--headless',
        action='store_true',
        help='Run browser in headless mode'
    )

    parser.add_argument(
        '--interactive-console',
        action='store_true',
        help='Enable interactive console mode'
    )

    parser.add_argument(
        '--output',
        default='pentest_results.json',
        help='Output file for results (default: pentest_results.json)'
    )

    args = parser.parse_args()

    print("""
╔══════════════════════════════════════════════════════════════════╗
║         INTEGRATED PENETRATION TESTING SUITE                     ║
╠══════════════════════════════════════════════════════════════════╣
║  Interactive Selenium | Native Proxy | Console Testing           ║
╚══════════════════════════════════════════════════════════════════╝
""")

    print(f"Target: {args.target}")
    print(f"Mode: {args.mode}")
    print(f"Proxy: {'Enabled' if args.proxy else 'Disabled'}")
    print(f"Browser: {args.browser}")
    print("")

    results = {
        'target': args.target,
        'mode': args.mode,
        'proxy_enabled': args.proxy,
        'results': {}
    }

    # Start proxy if requested
    proxy = None
    if args.proxy:
        proxy = start_proxy(args.proxy_port)

        if proxy:
            print(f"[+] Proxy started on port {args.proxy_port}")
            print(f"[*] Configure your system to use proxy: 127.0.0.1:{args.proxy_port}")
            time.sleep(2)

    # Prepare options
    options = {
        'browser': args.browser,
        'headless': args.headless,
        'proxy_enabled': args.proxy,
        'proxy_port': args.proxy_port,
        'console_mode': True
    }

    try:
        # Run based on mode
        if args.mode == 'interactive':
            results['results']['interactive'] = run_interactive_mode(args.target, options)

        elif args.mode == 'console':
            console_options = options.copy()
            console_options['interactive'] = args.interactive_console
            results['results']['console'] = run_console_tests(args.target, console_options)

        elif args.mode == 'full':
            print("\n[*] Running full test suite...")

            # Run console tests first
            print("\n[PHASE 1] Console Tests")
            print("="*60)
            results['results']['console'] = run_console_tests(args.target, options)

            time.sleep(2)

            # Then interactive mode
            print("\n[PHASE 2] Interactive Mode")
            print("="*60)
            results['results']['interactive'] = run_interactive_mode(args.target, options)

        # Save results
        with open(args.output, 'w') as f:
            json.dump(results, f, indent=2)

        print(f"\n[+] Results saved to {args.output}")

        # Print summary
        print_summary(results)

    except KeyboardInterrupt:
        print("\n[*] Interrupted by user")

    except Exception as e:
        print(f"\n[!] Error: {e}")
        import traceback
        traceback.print_exc()

    finally:
        if proxy:
            print("\n[*] Stopping proxy...")
            # Proxy will stop automatically when program exits

    print("\n[*] Testing complete")


def print_summary(results):
    """Print test summary"""
    print("\n" + "="*60)
    print("INTEGRATED PENTEST SUMMARY")
    print("="*60)

    total_vulns = 0

    if 'console' in results.get('results', {}):
        console_results = results['results']['console']
        if console_results:
            vulns = len(console_results.get('vulnerabilities', []))
            total_vulns += vulns
            print(f"\nConsole Tests:")
            print(f"  Tests Run: {len(console_results.get('tests', []))}")
            print(f"  Vulnerabilities: {vulns}")

    if 'interactive' in results.get('results', {}):
        interactive_results = results['results']['interactive']
        if interactive_results:
            vulns = len(interactive_results.get('vulnerabilities', []))
            total_vulns += vulns
            print(f"\nInteractive Tests:")
            print(f"  Tests Performed: {len(interactive_results.get('tests_performed', []))}")
            print(f"  Vulnerabilities: {vulns}")

    print(f"\nTotal Vulnerabilities Found: {total_vulns}")

    if total_vulns > 0:
        print("\n[!] VULNERABILITIES DETECTED - Review results file for details")
    else:
        print("\n[+] No critical vulnerabilities detected")

    print("="*60)


if __name__ == "__main__":
    main()
